{"version":3,"sources":["../src/scalejs.metadataFactory.js"],"names":[],"mappings":"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","file":"scalejs.metadataFactory.js","sourcesContent":["import ko from 'knockout';\r\nimport _ from 'lodash';\r\nimport view from './views/metadataFactory.html';\r\nimport moment from 'moment';\r\nimport sandbox from 'scalejs.sandbox';\r\nimport 'scalejs.expression-jsep';\r\nimport core from 'scalejs.core';\r\nimport 'scalejs.mvvm';\r\n\r\ncore.mvvm.registerTemplates(view);\r\n\r\nvar has = core.object.has,\r\n    is = core.type.is,\r\n    computed = ko.computed,\r\n    evaluate = core.expression.evaluate,\r\n    observable = ko.observable,\r\n    observableArray = ko.observableArray,\r\n    viewModels = {\r\n        '': defaultViewModel,\r\n        context: contextViewModel\r\n    },\r\n    schemas = {\r\n\r\n    },\r\n    identifiers = {},\r\n    useDefault = true;\r\n\r\n\r\nfunction createViewModel(node) {\r\n    var rendered = observable(true),\r\n        context = this;\r\n\r\n    node = _.cloneDeep(node); //clone the node to stop mutation issues\r\n\r\n    // if(!this || !this.metadata) {\r\n    //     console.warn('Creating viewmodel without metadata context. If metadata context is desired, call this function using \"this\"');\r\n    // }\r\n    if (node && node.type === 'ignore') {\r\n        console.log('ignored node ', node);\r\n    } else {\r\n        var mappedNode = viewModels[node.type] ? viewModels[node.type].call(this, node) : defaultViewModel.call(this, node);\r\n\r\n\r\n        if (mappedNode && has(node.rendered)) {\r\n            rendered = is(node.rendered, 'boolean') ? observable(node.rendered) : computed(function() {\r\n                return evaluate(node.rendered, function(id) {\r\n                    if (context.getValue && has(context.getValue(id))) {\r\n                        return context.getValue(id);\r\n                    }\r\n                    if (id === 'role') {\r\n                        return core.userservice.role();\r\n                    }\r\n                    return '';\r\n                })\r\n            });\r\n        }\r\n        if (mappedNode) {\r\n            mappedNode.type = mappedNode.type || node.type;\r\n            mappedNode.rendered = rendered;\r\n        }\r\n        return mappedNode;\r\n    }\r\n}\r\n\r\nfunction createViewModels(metadata) {\r\n    var metadataContext;\r\n\r\n    // if(!this || !this.metadata) {\r\n    //     console.warn('A new instance of metadata has been detected, therefore a new context will be created');\r\n    // }\r\n\r\n    // allows all viewmodels created in the same instane of metadata\r\n    // to share context (as long as createViewModels is called correctly)\r\n    if (this && this.metadata) {\r\n        metadataContext = this;\r\n    } else {\r\n        metadataContext = {\r\n            metadata: metadata,\r\n            // default getValue can grab from the store\r\n            getValue: function(id) {\r\n                if (id === 'store' && core.noticeboard.global) {\r\n                    return ko.unwrap(core.noticeboard.global.dictionary);\r\n                }\r\n                if (id === '_') {\r\n                    return _;\r\n                }\r\n                if (id == 'Date') {\r\n                    return function(d) {\r\n                        return moment(d).toDate().getTime();\r\n                    }\r\n                }\r\n                if (id == 'IncrementDate') {\r\n                    return function(d, t, s) {\r\n                        return moment(d).add(t, s).toDate().getTime();\r\n                    }\r\n                }\r\n                return identifiers[id];\r\n            }\r\n        };\r\n    }\r\n\r\n    return metadata.map(function(item) {\r\n        return createViewModel.call(metadataContext, item)\r\n    }).filter(function(vm) {\r\n        // filter undefined or null from the viewmodels array\r\n        return has(vm);\r\n    });\r\n}\r\n\r\nfunction createTemplate(metadata, context) {\r\n    if (!metadata) {\r\n        return core.mvvm.template('metadata_loading_template');\r\n    }\r\n    if (!Array.isArray(metadata)) {\r\n        metadata = [metadata];\r\n    }\r\n\r\n    var viewModels = !context ? createViewModels(metadata) : createViewModels.call(context, metadata);\r\n\r\n    return core.mvvm.template('metadata_items_template', viewModels);\r\n}\r\n\r\nfunction defaultViewModel(node) {\r\n    if (!useDefault) {\r\n        return;\r\n    }\r\n    return core.object.merge(node, {\r\n        template: 'metadata_default_template'\r\n    });\r\n}\r\n\r\nfunction contextViewModel(node) {\r\n    var newContextProps = {};\r\n    Object.keys(node).forEach(function(prop) {\r\n        if (prop === 'type') {\r\n            return;\r\n        }\r\n        if (Array.isArray(node[prop])) {\r\n            newContextProps[prop] = observableArray(node[prop]);\r\n        } else {\r\n            newContextProps[prop] = observable(node[prop]);\r\n        }\r\n    });\r\n    core.object.extend(this, newContextProps);\r\n}\r\n\r\nfunction registerViewModels(newViewModels) {\r\n    core.object.extend(viewModels, newViewModels);\r\n}\r\n\r\nfunction getRegisteredTypes() {\r\n    return Object.keys(viewModels);\r\n}\r\n\r\nfunction registerIdentifiers(ids) {\r\n    core.object.extend(identifiers, ids);\r\n}\r\n\r\nfunction dispose(metadata) {\r\n    // clean up clean up everybody everywhere\r\n    ko.unwrap(metadata).forEach(function(node) {\r\n        if (node.dispose) {\r\n            node.dispose();\r\n        }\r\n        dispose(node.mappedChildNodes || []);\r\n    })\r\n}\r\n\r\nfunction registerSchema(schema) {\r\n    for (var key in schema) {\r\n        // if( schemas.hasOwnProperty(key) ){\r\n        if (key !== '') {\r\n            schemas[key] = schema[key];\r\n        }\r\n    }\r\n}\r\n\r\nfunction generateSchema() {\r\n\r\n    //Basic schema layout for pjson\r\n    var schema = {\r\n        '$schema': 'http://json-schema.org/draft-04/schema#',\r\n        'definitions': {\r\n            'template': {\r\n                'type': 'string'\r\n            },\r\n            'type': {\r\n                'type': 'string'\r\n            },\r\n            'templateExt': {\r\n                'oneOf': [\r\n                    // case where no template is provided\r\n                    {\r\n                        'not': {\r\n                            'required': ['template']\r\n                        }\r\n                    }\r\n                ]\r\n            },\r\n            'typeExt': {\r\n                'oneOf': []\r\n            },\r\n            'children': {\r\n                'type': 'array',\r\n                'items': {\r\n                    '$ref': '#/definitions/subObject'\r\n                }\r\n            },\r\n            'options': {\r\n                'type': 'object'\r\n            },\r\n            'classes': {\r\n                'type': 'string'\r\n            },\r\n            'subObject': {\r\n                'allOf': [{\r\n                        // Base properties\r\n                        'type': 'object',\r\n                        'properties': {\r\n                            'template': {}, // makes sure template/type show up as options\r\n                            'type': {},\r\n                            'children': {\r\n                                '$ref': '#/definitions/children'\r\n                            },\r\n                            'options': {\r\n                                '$ref': '#/definitions/options'\r\n                            }\r\n                        },\r\n                        'required': ['type']\r\n                    },\r\n                    // populates templates, types, and corresponding options\r\n                    {\r\n                        '$ref': '#/definitions/typeExt'\r\n                    }, {\r\n                        '$ref': '#/definitions/templateExt'\r\n                    }\r\n                ]\r\n            }\r\n        },\r\n        'oneOf': [{\r\n            '$ref': '#/definitions/subObject'\r\n        }, {\r\n            'type': 'array',\r\n            'items': {\r\n                '$ref': '#/definitions/subObject'\r\n            }\r\n        }]\r\n    };\r\n\r\n    //Add all templates to the schema\r\n    var option;\r\n    var otherTemplates = [];\r\n    for (var key in core.mvvm.getRegisteredTemplates()) {\r\n        if (key !== '') {\r\n            if (schemas.hasOwnProperty(key)) {\r\n                // Add extended templates\r\n                option = {\r\n                    'properties': {\r\n                        'template': {\r\n                            'enum': [key]\r\n                        },\r\n                        'options': {\r\n                            'type': 'object',\r\n                            'properties': schemas[key]\r\n                        }\r\n                    },\r\n                    'required': ['template'] // ensures matching template\r\n                }\r\n                schema.definitions.templateExt.oneOf.push(option);\r\n            } else {\r\n                otherTemplates.push(key);\r\n            }\r\n        }\r\n    }\r\n    if (otherTemplates.length > 0) {\r\n        // Add regular templates\r\n        schema.definitions.template.enum = otherTemplates;\r\n        option = {\r\n            'properties': {\r\n                'template': {\r\n                    '$ref': '#/definitions/template'\r\n                }\r\n            },\r\n            'required': ['template'] // ensures matching template\r\n        }\r\n        schema.definitions.templateExt.oneOf.push(option);\r\n    }\r\n\r\n    //Add all types to the schema\r\n    var otherTypes = [];\r\n    for (var key in viewModels) {\r\n        if (key !== '') {\r\n            if (schemas.hasOwnProperty(key + '_template')) {\r\n                // Add extended types\r\n                var option = {\r\n                    'properties': {\r\n                        'type': {\r\n                            'enum': [key]\r\n                        },\r\n                        'options': {\r\n                            'type': 'object',\r\n                            'properties': schemas[key + '_template']\r\n                        }\r\n                    }\r\n                }\r\n                schema.definitions.typeExt.oneOf.push(option);\r\n            } else {\r\n                otherTypes.push(key);\r\n            }\r\n        }\r\n    }\r\n    if (otherTypes.length > 0) {\r\n        // Add regular types\r\n        schema.definitions.type.enum = otherTypes;\r\n        option = {\r\n            'properties': {\r\n                'type': {\r\n                    '$ref': '#/definitions/type'\r\n                }\r\n            }\r\n        }\r\n        schema.definitions.typeExt.oneOf.push(option);\r\n    }\r\n\r\n    return schema;\r\n\r\n}\r\n\r\nko.bindingHandlers.metadataFactory = {\r\n    init: function() {\r\n        return {\r\n            controlsDescendantBindings: true\r\n        };\r\n    },\r\n    update: function(\r\n        element,\r\n        valueAccessor,\r\n        allBindings,\r\n        viewModel,\r\n        bindingContext\r\n    ) {\r\n\r\n\r\n        var metadata = ko.unwrap(valueAccessor()).metadata ? ko.unwrap(valueAccessor()).metadata : ko.unwrap(valueAccessor()),\r\n            context = ko.unwrap(valueAccessor()).context ? ko.unwrap(valueAccessor()).context : null,\r\n            prevMetadata;\r\n\r\n        function disposeMetadata() {\r\n            prevMetadata = ko.utils.domData.get(element, 'metadata');\r\n\r\n            if (prevMetadata) {\r\n                prevMetadata = Array.isArray(prevMetadata) ? prevMetadata : [prevMetadata];\r\n                dispose(prevMetadata);\r\n            }\r\n        }\r\n\r\n\r\n        setTimeout(function() {\r\n            var metadataTemplate = createTemplate(metadata, context).template;\r\n\r\n            disposeMetadata();\r\n\r\n            ko.utils.domData.set(element, 'metadata', metadataTemplate.data);\r\n\r\n            ko.bindingHandlers.template.update(\r\n                element,\r\n                function() {\r\n                    return metadataTemplate;\r\n                },\r\n                allBindings,\r\n                viewModel,\r\n                bindingContext\r\n            );\r\n\r\n            // first time running - set dom node disposal\r\n            if (!prevMetadata) {\r\n                ko.utils.domNodeDisposal.addDisposeCallback(element, function() {\r\n                    disposeMetadata();\r\n                });\r\n            }\r\n        });\r\n    }\r\n\r\n}\r\n\r\nexport default core.registerExtension({\r\n        metadataFactory: {\r\n            createTemplate,\r\n            registerViewModels,\r\n            createViewModels,\r\n            createViewModel,\r\n            useDefault,\r\n            registerIdentifiers,\r\n            getRegisteredTypes\r\n        }\r\n    })"]}